name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  MIN_COVERAGE: ${{ vars.MIN_COVERAGE }}
  # Tier 1 - no internal dependencies
  TIER1_PACKAGES: >-
    packages/dart_logging
    packages/dart_node_core
    packages/dart_jsx
  # Tier 2 - depends on tier 1
  TIER2_PACKAGES: >-
    packages/reflux
    packages/dart_node_express
    packages/dart_node_ws
    packages/dart_node_better_sqlite3
    packages/dart_node_mcp
    packages/dart_node_react
    packages/dart_node_react_native
  # Examples
  EXAMPLES: >-
    examples/mobile
    examples/too_many_cooks
    examples/jsx_demo
  # Examples that need build step (no coverage)
  BUILD_EXAMPLES: >-
    examples/backend
    examples/frontend

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Install cspell
        run: npm install -g cspell

      - name: Spell check
        run: cspell "**/*.md" "**/*.dart" "**/*.ts" --no-progress

      - name: Get all dependencies
        run: |
          for dir in $TIER1_PACKAGES $TIER2_PACKAGES $EXAMPLES $BUILD_EXAMPLES examples/shared tools/build; do
            echo "::group::$dir"
            cd $dir && dart pub get && cd - > /dev/null
            echo "::endgroup::"
          done

      - name: Check formatting
        run: |
          dart format --set-exit-if-changed packages/
          dart format --set-exit-if-changed examples/
          dart format --set-exit-if-changed tools/build

      - name: Analyze
        run: |
          for dir in $TIER1_PACKAGES $TIER2_PACKAGES $EXAMPLES $BUILD_EXAMPLES examples/shared tools/build; do
            echo "::group::Analyzing $dir"
            cd $dir && dart analyze --no-fatal-warnings && cd - > /dev/null
            echo "::endgroup::"
          done

  test-tier1:
    name: Test Tier 1 (Core)
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Activate coverage tool
        run: dart pub global activate coverage

      - name: Get dependencies
        run: |
          for dir in $TIER1_PACKAGES; do
            cd $dir && dart pub get && cd - > /dev/null
          done

      - name: Test all tier 1 packages in parallel
        run: ./tools/test_parallel.sh $MIN_COVERAGE $TIER1_PACKAGES

  test-tier2:
    name: Test Tier 2 (Dependent Packages)
    needs: test-tier1
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Activate coverage tool
        run: dart pub global activate coverage

      - name: Get dependencies
        run: |
          for dir in $TIER1_PACKAGES $TIER2_PACKAGES; do
            cd $dir && dart pub get && cd - > /dev/null
          done

      - name: Test all tier 2 packages in parallel
        run: ./tools/test_parallel.sh $MIN_COVERAGE $TIER2_PACKAGES

  test-examples:
    name: Test Examples
    needs: test-tier2
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Activate coverage tool
        run: dart pub global activate coverage

      - name: Get dependencies
        run: |
          for dir in $TIER1_PACKAGES $TIER2_PACKAGES examples/shared $EXAMPLES tools/build; do
            cd $dir && dart pub get && cd - > /dev/null
          done

      - name: Test all examples in parallel
        run: ./tools/test_parallel.sh $MIN_COVERAGE $EXAMPLES

  build:
    name: Build
    needs: test-examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Get all dependencies
        run: |
          for dir in $TIER1_PACKAGES $TIER2_PACKAGES examples/shared $EXAMPLES $BUILD_EXAMPLES tools/build; do
            cd $dir && dart pub get && cd - > /dev/null
          done

      - name: Install Node dependencies
        working-directory: examples/backend
        run: npm install

      - name: Build and test build examples
        run: |
          for target in backend frontend mobile; do
            echo "::group::Building $target"
            dart run tools/build/build.dart $target
            echo "::endgroup::"
          done
          echo "::group::Testing backend"
          cd examples/backend && dart test
          echo "::endgroup::"
          echo "::group::Testing frontend"
          cd examples/frontend && dart test -p chrome
          echo "::endgroup::"
