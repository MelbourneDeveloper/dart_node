name: Release

on:
  push:
    tags:
      - 'Release/[0-9]+.[0-9]+.[0-9]+*'

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate tag is on main
        run: |
          git fetch origin main
          if ! git merge-base --is-ancestor ${{ github.sha }} origin/main; then
            echo "::error::Release tag must be created from main branch!"
            exit 1
          fi

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/Release/}" >> $GITHUB_OUTPUT

      - name: Setup Dart
        uses: ./.github/actions/setup
        with:
          dart-version: ${{ vars.DART_VERSION }}

      - name: Prepare for publishing (switch to pub.dev deps)
        run: dart run tools/prepare_publish.dart ${{ steps.version.outputs.VERSION }}

      - name: Create release branch and commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b release/${{ steps.version.outputs.VERSION }}
          git add -A
          git commit -m "chore: prepare release ${{ steps.version.outputs.VERSION }} with pub.dev dependencies"
          git push origin release/${{ steps.version.outputs.VERSION }}

      - name: Create PR to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "Release ${{ steps.version.outputs.VERSION }}" \
            --body "## Release ${{ steps.version.outputs.VERSION }}

          This PR is auto-created from the release tag.

          **Do not merge yet!** Publishing happens in tier workflows (tier1 → tier2 → tier3).

          After tier3 completes, dependencies will be switched back to local and this PR will be updated.

          ### Publishing Tiers
          - Tier 1: dart_logging, dart_node_core (triggered by this workflow)
          - Tier 2: reflux, dart_node_express, dart_node_ws, dart_node_better_sqlite3, dart_node_mcp (20 min wait)
          - Tier 3: dart_node_react, dart_node_react_native (20 min wait)" \
            --base main \
            --head release/${{ steps.version.outputs.VERSION }}
