name: Publish Packages

on:
  workflow_call:
    inputs:
      tier:
        description: 'Tier number (1, 2, or 3)'
        required: true
        type: number
      packages:
        description: 'Space-separated list of package names'
        required: true
        type: string
      environment:
        description: 'GitHub environment name (for wait timer)'
        required: false
        type: string
        default: 'pub.dev'

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find release branch
        id: branch
        run: |
          # Find the most recent release branch
          git fetch origin 'refs/heads/release/*:refs/remotes/origin/release/*'
          RELEASE_BRANCH=$(git branch -r --list 'origin/release/*' --sort=-committerdate | head -1 | sed 's/.*origin\///')
          if [ -z "$RELEASE_BRANCH" ]; then
            echo "::error::No release branch found"
            exit 1
          fi
          echo "BRANCH=$RELEASE_BRANCH" >> $GITHUB_OUTPUT
          echo "Found release branch: $RELEASE_BRANCH"

      - name: Checkout release branch
        run: git checkout ${{ steps.branch.outputs.BRANCH }}

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Get version from branch
        id: version
        run: |
          BRANCH="${{ steps.branch.outputs.BRANCH }}"
          VERSION="${BRANCH#release/}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Verify prerequisite packages on pub.dev
        if: inputs.tier > 1
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Tier 2 needs dart_node_core and dart_logging
          if [ "${{ inputs.tier }}" = "2" ]; then
            PREREQS="dart_node_core dart_logging"
          fi

          # Tier 3 needs dart_node_express (tier 2 indicator)
          if [ "${{ inputs.tier }}" = "3" ]; then
            PREREQS="dart_node_express"
          fi

          for pkg in $PREREQS; do
            echo "Checking $pkg $VERSION on pub.dev..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pub.dev/api/packages/$pkg/versions/$VERSION")
            if [ "$HTTP_CODE" != "200" ]; then
              echo "::error::$pkg $VERSION not available on pub.dev yet"
              exit 1
            fi
            echo "$pkg $VERSION is available"
          done

      - name: Publish packages
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          for pkg in ${{ inputs.packages }}; do
            echo "::group::Publishing $pkg"
            # Skip if already published
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pub.dev/api/packages/$pkg/versions/$VERSION")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚è≠ $pkg $VERSION already published, skipping"
              echo "::endgroup::"
              continue
            fi
            cd packages/$pkg
            dart pub get
            dart pub publish --force
            cd ../..
            echo "::endgroup::"
          done
